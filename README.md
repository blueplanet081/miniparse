# miniparse -- 簡易コマンドラインパーサ

## 作成経緯

CLIベースのコマンドを試作／製作するとき、起動オプションの処理を手軽に記述したかった。同種のものを探したけど見つからなかったので、Python学習も兼ねて作成。

</br>

## 特徴（宣伝）

- オプション情報を羅列するだけで定義でき、関数呼び出し一つで解析できるので、手軽に使えると思います。
- 入力エラー時に、簡易的な Usage:（もどき）情報や、オプション情報リストを自動生成して表示できます。
- エラーメッセージや Usage:表示などを（自動で表示するものの代わりに）ユーザ定義できます。
- コマンド引数の後ろにオプションを入力するパターンとか、わりといろいろ対処できるようにしたつもりです。

</br>

## 動作環境

Python 3.7以降
- 作成と主なテストは Python 3.8 を使用しています。
- 3.6 でも動くかもしれませんが、テストしていません。
- Enum を使っているので、3.6より古い環境では多分動きません。

</br>

## **ファイル構成**

ファイル名         | 内容
------------------|----
README.md         | このドキュメント
miniparse.md      | もう少し詳しい説明
miniparse.py      | miniparse本体（使うのに必要なのはこのファイルだけです）
ptree.py          | miniparse使用サンプル。いわゆる treeコマンドの試作版です。
e2_path.py        | ptree.pyが呼び出している自作ライブラリ（添付用簡易版）
mp_sample01.py    | 一番シンプルなサンプル
mp_sample02.py    | エラー時にユーザ側で処理するサンプル
mp_sample03.py    | Usage:情報とか、ユーザ定義するサンプル
mp_sample04.py    | 区切りモードのサンプル
mp_sample04b.py   | 区切りながら最後まで解析するサンプル
mp_sample04c.py   | 区切りながら、その都度リセットして最後まで解析するサンプル

</br>

## **履歴**

バージョン   |日付     |変更箇所        | コメント 
------------|---------|---------------|------
0.5くらい    |2020/8/27|               |いちおう完成
0.6くらい    |2020/9/1 |miniparse.py  |コマンド引数のホームディレクトリ、ワイルドカード展開を追加</br>(Windowsで使用の場合のみ)
0.8くらい    |2020/9/3|miniparse.py   |Let's Python@facebook でアドバイスを受けて、解析部大幅変更</br>(一部機能制限暫定版)
煮え切らない0.9|2020/9/15    |miniparse.py |完全版だけど、まだ使用実績ナシ


</br>

## **使い方（超簡易版）**

```py
import sys
import miniparse as mp

pms: mp.TypeOpList = [('', False, 'ファイル名'),
                      ('l', False, '', '詳細情報も表示する'),
                      ('h', False, '', '使い方を表示する'),
                      ('help', False, '', '使い方を表示する'),
                      ]
opp = mp.OpSet(pms)
mp.miniparse(opp, sys.argv)

```

  1. miniparse を importする。
  2. オプション情報を定義、クラス OpSet()のインスタンスを作成する。
  3. 上記のインスタンス、コマンドライン引数を指定して、コマンドライン解析関数 miniparse() を呼び出す。
</br>
</br>
</br>

```py
''' オプションの取得 '''
for op in opp.get_keys():
    if opp.isTrue(op):
        if len(op) == 0 and opp.get_opArg(op):
            print('コマンド引数が入力された。', opp.get_opArg(op))
        if len(op) == 1:
            print(f'option -{op} が指定された。')
        if len(op) > 1:
            print(f'option --{op} が指定された。')

''' コマンド引数の取得 '''
arglist = mp.get_arguments()
if arglist:
    print()
    print('コマンド引数リスト = ')
    for arg in arglist:
        print(f'  [{arg}]')

''' HELPメッセージ出力サンプル '''
if opp.isTrue('h') or opp.isTrue('help'):
    print('このプログラムは、モジュール miniparse の使い方を示すものです。')
    mp.printUsage('', opp, mp.Umode.BOTH)


```

  - get_keys()  </br>
  　　オプション文字、文字列の一覧を返す。
  - isTrue(op) </br>
  　　コマンドラインでそのオプション文字、または文字列（op）が指定されたら True。
  - get_arguments() </br>
  　　コマンドラインで指定された、コマンド引数のリストを返す。
  - printUsage(コマンド名、OpSetのインスタンス、Umode)　</br>
  　　簡単な Usage:を出力する。
    - コマンド名（省略時は、デフォルトのコマンド名）
    - Umode
      - Umode.USAGE　　Usage行のみ出力する
      - Umode.OLIST　　オプションリストを出力する
      - Umode.BOTH　 　Usage: とオプションリストの両方を出力する
</br>
</br>
</br>

## コマンドラインの構成とか、言葉の定義とかルール
注）ここで記述している内容は、本モジュールでのコマンドラインの扱いで、オフィシャルなものとかではありません。

</br>

### コマンドラインの構成

コマンド名 -a -b -c -d オプション引数 --version --output=オプション引数2 コマンド引数 コマンド引数2

-a、-b、-c、-d １文字オプション（'a'、'b'、'c'、'd' オプション文字）
--version、--output  ロング名オプション（version、output　オプション文字列）


### オプションのルール
- すべてのオプションは省略可
- オプションの指定順位は任意 </br>
　→ '-a -b -c --version' でも、'-b --version -a -c' でも、'--version -b -c -a' でも同じ
</br>
</br>

### １文字オプションのルール
- オプション文字は英数字１文字。
- １文字オプションがオプション引数をとるときは、オプションの直後に続けて指定、または空白をおいて指定する。</br>
　→ -d オプション引数、または -dオプション引数
- 複数の１文字オプションは、個別に入力しても良いし、- の後に続けて指定しても良い。</br>
　→ -a -b -c と、-abc、-a -bc、-ac -b などすべて同じ
- ただし、引数付き１文字オプションは、続けて指定する場合は一連の最後に指定する</br>
　→ -abd オプション引数、 -cdオプション引数 -ab など（-d がオプション引数必須の場合）。
- 引数付き１文字オプションは、オプション引数は省略不可。
</br>
</br>

### ロング名オプションのルール
- ロング名オプションのオプション文字列は、一意に判別できる限り省略して指定できる。
　→ --version、--verboseの２つのオプションがある時、'version'は、'versio'、'versi'、'vers'と省略できる。
- ロング名オプションのオプション引数は、オプション文字列の後の'='に続けて指定する。または空白をおいて指定する。
- オプション引数が省略可能なロング名オプションの場合、空白をおいて指定は不可。
</br>
</br>

### コマンド引数のルール
- 頭に'-'（ハイフン）が付かない文字、または文字列で、前記のオプション引数に該当しない単独文字、または文字列は、コマンド引数として認識される。
</br>
</br>

### 例外ルール
- '--'（ハイフン２つ）のみの文字列が存在した場合、その次の単独文字、または文字列は先頭に'-'（ハイフン）が付いていても強制的にオプション引数、またはコマンド引数と判断される。</br>
　→ -ab --version の場合、-a -b --version はすべて１文字、またはロング名オプション</br>
　→ -ab -- --version の場合、--version はコマンド引数、またはオプション引数（-b が引数付き１文字オプションの場合）
</br>
</br>

### 例外ルール２
- '-'（ハイフンひとつ）のみの文字が単独で存在した場合、現在はそのままコマンド引数、またはオプション引数と判断する。（後に仕様変更の可能性がある）
</br>
</br>

### ワイルドカード展開ルール
- コマンドラインの文字列中に「ワイルドカード」と判断される文字または文字列が含まれている場合、コマンドラインの解析に先立ってワイルドカードが展開される。
</br>
</br>

### ワイルドカード展開の抑制ルール
ワイルドカード展開をしたくない場合は、各文字列毎に、以下の手段で抑制できる。
  - 各文字列の頭に '\\' バックスラッシュを付ける。コマンドライン解析時は、バックスラッシュは削除される。
```
    → 「\*.py」 はワイルドカード展開されず、「*.py」として解釈される。
```
  - 各文字列をシングルクォートで囲む。コマンドライン解析時は、シングルクォートは削除される。
```
    → 「'*.py'」はワイルドカード展開されず、「*.py」として解釈される。
```
  - ただし、Windows環境では頭にスペースを一つ付けてシングルクォートで囲む。コマンドライン解析時は、シングルクォートとスペースは削除される。
```
    → 「' *.py'」はワイルドカード展開されず、「*.py」として解釈される（Windowsの場合）。
```

